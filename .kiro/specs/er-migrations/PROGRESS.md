# ER Migrations - å®ç°è¿›åº¦

## å·²å®Œæˆ âœ…

### Phase 1: åŸºç¡€æ¨¡å‹ (100%)
- âœ… **models.py** - å®Œæ•´çš„Pydanticæ•°æ®æ¨¡å‹
  - ColumnDefinition, IndexDefinition, ForeignKeyDefinition
  - æ‰€æœ‰æ“ä½œç±»å‹ (CreateTable, DropTable, AddColumn, AlterColumnç­‰)
  - Migrationæ¨¡å‹
  - æµ‹è¯•è¦†ç›–: 25ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡

- âœ… **file_manager.py** - è¿ç§»æ–‡ä»¶ç®¡ç†
  - è¯»å–/å†™å…¥YAMLæ ¼å¼çš„è¿ç§»æ–‡ä»¶
  - å‘½åç©ºé—´ç®¡ç†
  - æ–‡ä»¶åè‡ªåŠ¨ç”Ÿæˆ (0001_name.yamlæ ¼å¼)
  - æµ‹è¯•è¦†ç›–: 12ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡

### Phase 2: æ ¸å¿ƒç®—æ³• (100%)
- âœ… **converter.py** - ERæ¨¡å‹è½¬æ¢å™¨
  - å°†ç°æœ‰çš„ERModelè½¬æ¢ä¸ºè¿ç§»ç³»ç»Ÿçš„å†…éƒ¨è¡¨ç¤º
  - CamelCaseåˆ°snake_caseè½¬æ¢
  - ç´¢å¼•æå–
  - å…³ç³»è½¬æ¢ä¸ºå¤–é”®
  - æµ‹è¯•è¦†ç›–: 8ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
  
- âœ… **differ.py** - ERå›¾å·®å¼‚æ£€æµ‹
  - æ¯”è¾ƒä¸¤ä¸ªERæ¨¡å‹ï¼Œç”Ÿæˆæ“ä½œåˆ—è¡¨
  - æ£€æµ‹è¡¨/åˆ—/ç´¢å¼•çš„å˜æ›´
  - åªè®°å½•æ–°å€¼ï¼Œä¸è®°å½•æ—§å€¼
  - æµ‹è¯•è¦†ç›–: 11ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡

**æ€»è®¡: 56ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ âœ…**

---

## è¿›è¡Œä¸­ ğŸš§

### Phase 3: è¿ç§»ç”Ÿæˆ
- â³ **generator.py** - è¿ç§»ç”Ÿæˆå™¨
  - ä»ERå›¾ç”Ÿæˆè¿ç§»æ–‡ä»¶
  - è‡ªåŠ¨è®¡ç®—ä¾èµ–å…³ç³»

---

## å¾…å®ç° ğŸ“‹

### Phase 3: çŠ¶æ€ç®¡ç†
- â³ **state_builder.py** - çŠ¶æ€é‡å»ºå™¨
  - ä»è¿ç§»å†å²é‡å»ºERçŠ¶æ€
  - ä¾èµ–è§£æå’Œæ’åº
  
- â³ **dependency_resolver.py** - ä¾èµ–è§£æå™¨
  - è§£æè¿ç§»ä¾èµ–å…³ç³»
  - æ£€æµ‹å¾ªç¯ä¾èµ–

### Phase 4: CLIå‘½ä»¤
- â³ **cli.py** - å‘½ä»¤è¡Œæ¥å£
  - `makemigrations` - ç”Ÿæˆè¿ç§»
  - `showmigrations` - æ˜¾ç¤ºè¿ç§»çŠ¶æ€
  - `rebuild-state` - é‡å»ºERçŠ¶æ€

---

## è®¾è®¡å†³ç­–è®°å½•

### 1. è¿ç§»è®°å½•åªä¿å­˜æ–°å€¼
**å†³ç­–**: AlterColumnç­‰æ“ä½œåªè®°å½•new_*å­—æ®µï¼Œä¸è®°å½•oldå€¼
**åŸå› **: 
- å‡å°‘å†—ä½™
- è¿ç§»æ–‡ä»¶æ›´ç®€æ´
- å¦‚éœ€æ—§å€¼ï¼Œå¯ä»å†å²è¿ç§»é‡å»º

**ç¤ºä¾‹**:
```yaml
# ç®€æ´çš„æ ¼å¼
- type: AlterColumn
  table_name: user
  column_name: username
  new_max_length: 200
```

### 2. ä½¿ç”¨Pydanticè¿›è¡Œæ•°æ®éªŒè¯
**å†³ç­–**: æ‰€æœ‰æ•°æ®æ¨¡å‹ä½¿ç”¨Pydantic BaseModel
**åŸå› **:
- è‡ªåŠ¨ç±»å‹éªŒè¯
- åºåˆ—åŒ–/ååºåˆ—åŒ–æ”¯æŒ
- æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

### 3. YAMLä½œä¸ºè¿ç§»æ–‡ä»¶æ ¼å¼
**å†³ç­–**: ä½¿ç”¨YAMLè€ŒéJSONæˆ–Python
**åŸå› **:
- äººç±»å¯è¯»æ€§å¥½
- æ”¯æŒæ³¨é‡Š
- ä¸Django migrationsç±»ä¼¼çš„ä½“éªŒ

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. **å®ç°converter.py** - å°†ç°æœ‰ERModelè½¬æ¢ä¸ºè¿ç§»ç³»ç»Ÿæ ¼å¼
2. **å®ç°differ.py** - æ ¸å¿ƒå·®å¼‚æ£€æµ‹ç®—æ³•
3. **å®ç°generator.py** - è¿ç§»ç”Ÿæˆé€»è¾‘
4. **å®ç°state_builder.py** - çŠ¶æ€é‡å»ºåŠŸèƒ½
5. **å®ç°CLI** - ç”¨æˆ·å‘½ä»¤è¡Œæ¥å£

---

## æµ‹è¯•ç­–ç•¥

- âœ… æ¯ä¸ªæ¨¡å—éƒ½æœ‰å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶
- âœ… ä½¿ç”¨TDDæ–¹å¼å¼€å‘
- âœ… ç›®æ ‡è¦†ç›–ç‡: 90%+
- âœ… ä½¿ç”¨pytestå’Œpytest-cov

---

## æ–‡ä»¶ç»“æ„

```
src/x007007007/er_migrate/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ models.py           âœ… (å®Œæˆ)
â”œâ”€â”€ file_manager.py     âœ… (å®Œæˆ)
â”œâ”€â”€ converter.py        â³ (å¾…å®ç°)
â”œâ”€â”€ differ.py           â³ (å¾…å®ç°)
â”œâ”€â”€ generator.py        â³ (å¾…å®ç°)
â”œâ”€â”€ state_builder.py    â³ (å¾…å®ç°)
â””â”€â”€ cli.py              â³ (å¾…å®ç°)

tests/test_er_migrate/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ test_models.py      âœ… (25ä¸ªæµ‹è¯•)
â”œâ”€â”€ test_file_manager.py âœ… (12ä¸ªæµ‹è¯•)
â”œâ”€â”€ test_converter.py   â³
â”œâ”€â”€ test_differ.py      â³
â”œâ”€â”€ test_generator.py   â³
â”œâ”€â”€ test_state_builder.py â³
â””â”€â”€ test_cli.py         â³
```

---

## æ›´æ–°æ—¥æœŸ
2025-01-23
