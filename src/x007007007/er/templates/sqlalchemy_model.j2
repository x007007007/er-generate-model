from sqlalchemy import Column, Integer, String, ForeignKey, Boolean, Date, DateTime, Time, Text, Float, Numeric, JSON, Table
from sqlalchemy.orm import declarative_base, relationship

Base = declarative_base()
{%- if model.templates %}
{# 生成基类导入 #}
{%- set base_imports = [] %}
{%- for template_name, template_info in model.templates.items() %}
{%- if template_info.export_path %}
{%- set base_class_name = template_name | title | replace('_', '') + 'Mixin' %}
{%- if template_info.export_path not in base_imports %}
{%- set _ = base_imports.append(template_info.export_path) %}
from {{ template_info.export_path }} import {{ base_class_name }}
{%- endif %}
{%- endif %}
{%- endfor %}
{%- endif %}
{%- for entity in model.entities.values() %}
{%- set base_classes = [] %}
{%- if entity.extends %}
{%- for template_name in entity.extends %}
{%- if template_name in model.templates and model.templates[template_name].export_path %}
{%- set base_class_name = template_name | title | replace('_', '') + 'Mixin' %}
{%- set _ = base_classes.append(base_class_name) %}
{%- endif %}
{%- endfor %}
{%- endif %}

class {{ entity.name }}({% if base_classes %}{{ base_classes|join(', ') }}{% else %}Base{% endif %}):
{%- set table_name = entity.name|lower %}
{%- if table_prefix %}
{%- set table_name = table_prefix + '_' + table_name %}
{%- endif %}
    __tablename__ = '{{ table_name }}'
{%- set inherited_column_names = [] %}
{%- if entity.extends %}
{%- for template_name in entity.extends %}
{%- if template_name in model.templates %}
{%- if model.templates[template_name].export_path %}
{# 只有有export_path的模板字段才排除，没有export_path的会展开 #}
{%- for col in model.templates[template_name].columns %}
{%- set _ = inherited_column_names.append(col.name) %}
{%- endfor %}
{%- endif %}
{%- endif %}
{%- endfor %}
{%- endif %}
{%- for col in entity.columns %}
{%- if col.name not in inherited_column_names %}
{%- if col.is_fk %}
{%- set rel = none %}
{%- for r in model.relationships %}
{%- if r.right_column == col.name and r.right_entity == entity.name %}
{%- set rel = r %}
{%- endif %}
{%- endfor %}
{%- if rel %}
{%- set fk_table_name = rel.left_entity|lower %}
{%- if table_prefix %}
{%- set fk_table_name = table_prefix + '_' + fk_table_name %}
{%- endif %}
    {{ col.name }} = Column(Integer, ForeignKey('{{ fk_table_name }}.id'){% if not col.nullable %}, nullable={{ col.nullable }}{% endif %}{% if col.comment %}, comment="{{ col.comment }}"{% endif %})
{%- else %}
{%- set column_type, params = col | sqlalchemy_column_type %}
{%- set param_list = [] %}
{%- if col.is_pk %}
{%- set _ = param_list.append('primary_key=True') %}
{%- endif %}
{%- if not col.nullable %}
{%- set _ = param_list.append('nullable=' + col.nullable|string) %}
{%- endif %}
{%- if col.comment %}
{%- set _ = param_list.append('comment="' + col.comment + '"') %}
{%- endif %}
    {{ col.name }} = Column({{ column_type }}{% if param_list %}, {{ param_list|join(', ') }}{% endif %})
{%- endif %}
{%- else %}
{%- set column_type, params = col | sqlalchemy_column_type %}
{%- set param_list = [] %}
{%- if col.is_pk %}
{%- set _ = param_list.append('primary_key=True') %}
{%- endif %}
{%- if not col.nullable %}
{%- set _ = param_list.append('nullable=' + col.nullable|string) %}
{%- endif %}
{%- if col.default %}
{%- set _ = param_list.append('default=' + col.default|string) %}
{%- endif %}
{%- if col.comment %}
{%- set _ = param_list.append('comment="' + col.comment + '"') %}
{%- endif %}
{%- if 'max_length' in params %}
    {{ col.name }} = Column({{ column_type }}({{ params.max_length }}){% if param_list %}, {{ param_list|join(', ') }}{% endif %})
{%- else %}
    {{ col.name }} = Column({{ column_type }}{% if param_list %}, {{ param_list|join(', ') }}{% endif %})
{%- endif %}
{%- endif %}
{%- endif %}
{%- endfor %}
{%- for rel in model.relationships %}
{%- if rel.right_entity == entity.name %}
{%- if rel.relation_type == 'one-to-one' %}
    {{ rel.left_entity|lower }}_rel = relationship("{{ rel.left_entity }}", uselist=False, back_populates="{{ entity.name|lower }}_rel")
{%- elif rel.relation_type == 'one-to-many' %}
    {{ rel.left_entity|lower }}_rel = relationship("{{ rel.left_entity }}", back_populates="{{ entity.name|lower }}_set")
{%- elif rel.relation_type == 'many-to-many' %}
{%- set assoc_table = [rel.left_entity|lower, rel.right_entity|lower] | sort | join('_') + '_association' %}
{%- if table_prefix %}
{%- set assoc_table = table_prefix + '_' + assoc_table %}
{%- endif %}
    {{ rel.left_entity|lower }}_set = relationship("{{ rel.left_entity }}", secondary="{{ assoc_table }}", back_populates="{{ entity.name|lower }}_set")
{%- endif %}
{%- elif rel.left_entity == entity.name %}
{%- if rel.relation_type == 'one-to-one' %}
    {{ rel.right_entity|lower }}_rel = relationship("{{ rel.right_entity }}", uselist=False, back_populates="{{ entity.name|lower }}_rel")
{%- elif rel.relation_type == 'one-to-many' %}
    {{ rel.right_entity|lower }}_set = relationship("{{ rel.right_entity }}", back_populates="{{ entity.name|lower }}_rel")
{%- elif rel.relation_type == 'many-to-many' %}
{%- set assoc_table = [rel.left_entity|lower, rel.right_entity|lower] | sort | join('_') + '_association' %}
{%- if table_prefix %}
{%- set assoc_table = table_prefix + '_' + assoc_table %}
{%- endif %}
    {{ rel.right_entity|lower }}_set = relationship("{{ rel.right_entity }}", secondary="{{ assoc_table }}", back_populates="{{ entity.name|lower }}_set")
{%- endif %}
{%- endif %}
{%- endfor %}
{%- endfor %}
{%- set many_to_many_tables = {} %}
{%- for rel in model.relationships %}
{%- if rel.relation_type == 'many-to-many' %}
{%- set assoc_table = [rel.left_entity|lower, rel.right_entity|lower] | sort | join('_') + '_association' %}
{%- if table_prefix %}
{%- set assoc_table = table_prefix + '_' + assoc_table %}
{%- endif %}
{%- if assoc_table not in many_to_many_tables %}
{%- set _ = many_to_many_tables.update({assoc_table: [rel.left_entity, rel.right_entity]}) %}
{%- set left_table = rel.left_entity|lower %}
{%- set right_table = rel.right_entity|lower %}
{%- if table_prefix %}
{%- set left_table = table_prefix + '_' + left_table %}
{%- set right_table = table_prefix + '_' + right_table %}
{%- endif %}
{{ assoc_table }} = Table(
    '{{ assoc_table }}',
    Base.metadata,
    Column('{{ rel.left_entity|lower }}_id', Integer, ForeignKey('{{ left_table }}.id')),
    Column('{{ rel.right_entity|lower }}_id', Integer, ForeignKey('{{ right_table }}.id'))
)
{%- endif %}
{%- endif %}
{%- endfor %}
